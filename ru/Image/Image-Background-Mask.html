<!DOCTYPE html>
<html lang="ru-RU">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CaliperTools - Инструмент фона и маски</title>
    <meta name="description" content="Обрабатывайте фоны и маски изображений с помощью 13 профессиональных инструментов. Удаляйте фоны, добавляйте цвета, применяйте маски и многое другое. Загрузка не требуется.">
    <link rel="icon" type="image/png" sizes="32x32" href="../../images/favicon32.png">
    <link rel="stylesheet" href="../../styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="../scripts/script.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
        }

        .bg-mask-container {
            display: flex;
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            background-color: #fff;
            height: 750px;
        }

        @media (max-width: 768px) {
            .bg-mask-container {
                flex-direction: column-reverse;
                height: auto;
            }

            .sidebar-container {
                width: 100%;
                border-right: none;
                border-top: 1px solid #ddd;
                border-bottom: none;
            }

            .sidebar {
                height: auto;
                max-height: none;
                padding: 15px;
            }

            .sidebar-content {
                max-height: none;
                overflow-y: visible;
            }

            .sidebar-actions {
                position: relative;
                border-top: 1px solid #ddd;
            }

            .canvas-area {
                height: auto;
                min-height: 400px;
                max-height: 60vh;
            }

            .upload-prompt {
                width: calc(100% - 40px);
                height: calc(100% - 40px);
            }

            .sidebar .tools-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
        }

        .sidebar-container {
            width: 380px;
            border-right: 1px solid #ddd;
        }

        .sidebar {
            padding: 20px;
            background-color: #ffffff;
            height: 750px;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding-bottom: 120px;
        }

        .sidebar-actions {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #ffffff;
            padding: 15px 20px;
            z-index: 10;
        }

        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: #bbb;
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: #999;
        }

        .upload-section {
            margin-bottom: 20px;
        }

        .upload-btn {
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: 100%;
        }

        .upload-btn:hover {
            background-color: #0056b3;
        }

        .file-input {
            display: none;
        }

        .file-upload-btn {
            padding: 8px 16px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }

        .file-upload-btn:hover {
            background: #2563eb;
        }

        .file-name {
            margin-left: 10px;
            color: #666;
            font-size: 14px;
            flex: 1;
        }

        .tools-section {
            margin-bottom: 20px;
        }

        .tools-section h2 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #0F172A;
        }

        .sidebar .tools-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .tool-btn {
            padding: 10px 5px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .tool-btn:hover {
            border-color: #007bff;
            background-color: rgba(0, 123, 255, 0.05);
        }

        .tool-btn.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }

        .tool-btn i {
            font-size: 18px;
        }

        .settings-section {
            margin-bottom: 20px;
        }

        .settings-section h2 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #0F172A;
        }

        .setting-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }

        .setting-label {
            font-size: 14px;
            color: #666;
            min-width: 80px;
        }

        .color-picker {
            width: 50px;
            height: 30px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }

        .help-icon {
            margin-left: 8px;
            color: #999;
            cursor: help;
            font-size: 14px;
            transition: color 0.3s ease;
        }

        .help-icon:hover {
            color: #3b82f6;
        }

        .setting-select {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .setting-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .size-slider {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: #ddd;
            outline: none;
            border-radius: 3px;
        }

        .size-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #007bff;
            cursor: pointer;
        }

        .size-display {
            width: 40px;
            text-align: right;
            font-size: 14px;
            color: #666;
        }

        .actions-section {
            margin-top: auto;
        }

        .action-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .action-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            min-width: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .clear-btn {
            background-color: #dc3545;
            color: white;
        }

        .download-btn {
            background-color: #28a745;
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .canvas-area {
            flex: 1;
            padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #ffffff;
            position: relative;
        }

        .upload-prompt {
            text-align: center;
            padding: 0;
            border: none;
            border-radius: 0;
            transition: all 0.3s ease;
            width: calc(100% - 80px);
            height: calc(100% - 80px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px dashed #ccc;
            border-radius: 8px;
        }

        .upload-prompt.drag-over {
            border-color: #007bff;
            background-color: rgba(0, 123, 255, 0.05);
        }

        .upload-prompt-icon {
            font-size: 60px;
            color: #007bff;
            margin-bottom: 20px;
        }

        .upload-prompt-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #0F172A;
        }

        .upload-prompt-instruction {
            font-size: 16px;
            color: #666;
            margin-bottom: 20px;
        }

        .canvas-wrapper {
            position: relative;
            display: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            background-color: transparent;
        }

        .delete-image-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            background-color: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .delete-image-btn:hover {
            background-color: rgba(220, 53, 69, 1);
            transform: scale(1.1);
        }

        .canvas-wrapper.active {
            display: block;
        }

        canvas {
            display: block;
        }

        #resultCanvas {
            position: relative;
        }

        .privacy-statement {
            margin-top: 20px;
            padding: 15px;
            background-color: #f0f9ff;
            border-left: 4px solid #3b82f6;
            border-radius: 4px;
            font-size: 14px;
            color: #1e40af;
        }

        /* Tutorial and Introduction Section Styles */
        .tutorial-section {
            background: linear-gradient(to right, #3b82f6, #8b5cf6);
            color: white;
            padding: 5rem 0;
            margin-top: 5rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }

        .text-4xl {
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 4rem;
        }

        .grid {
            display: grid;
            gap: 2rem;
        }

        .grid-cols-1 {
            grid-template-columns: 1fr;
        }

        @media (min-width: 640px) {
            .sm\:grid-cols-2 {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1024px) {
            .lg\:grid-cols-4 {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .tutorial-card {
            background: white;
            color: #1f2937;
            border-radius: 0.75rem;
            padding: 2rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .tutorial-card:hover {
            transform: scale(1.05);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .tutorial-card h3 {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .tutorial-icon {
            background: #3b82f6;
            color: white;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            font-size: 1.25rem;
        }

        .tutorial-card p {
            color: #6b7280;
            line-height: 1.5;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            cursor: help;
            font-size: 0.875rem;
        }

        /* Feature Section Styles */
        .feature-section {
            padding: 5rem 0;
            background: white;
        }

        .feature-section.gray {
            background: #f9fafb;
        }

        .grid-cols-2 {
            display: grid;
            grid-template-columns: 1fr;
            gap: 4rem;
            align-items: center;
        }

        @media (min-width: 768px) {
            .grid-cols-2 {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .content-image img {
            border-radius: 0.75rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            width: 100%;
        }

        .content-text h2 {
            font-size: 2.25rem;
            font-weight: bold;
            color: #111827;
            margin-bottom: 1.5rem;
        }

        .content-text p {
            font-size: 1.125rem;
            color: #6b7280;
            margin-bottom: 1.5rem;
            line-height: 1.75;
        }

        /* Order Classes */
        .order-2 {
            order: 2;
        }

        .order-1 {
            order: 1;
        }

        @media (min-width: 768px) {
            .md\:order-1 {
                order: 1;
            }
            .md\:order-2 {
                order: 2;
            }
        }

        /* Bottom Text Area */
        .bottom-text-section {
            padding: 5rem 0;
            background: linear-gradient(to bottom, #f9fafb, white);
        }

        .bottom-text-section h2 {
            font-size: 2.25rem;
            font-weight: bold;
            color: #111827;
            margin-bottom: 1.5rem;
        }

        .bottom-text-section p {
            font-size: 1.125rem;
            color: #6b7280;
            margin-bottom: 1.5rem;
            line-height: 1.75;
        }

        .mb-10 {
            margin-bottom: 2.5rem;
        }

        /* Related Tools Section */
        .related-tools {
            padding: 4rem 0;
            background: white;
        }

        .section-title {
            font-size: 2.25rem;
            font-weight: bold;
            color: #111827;
            margin-bottom: 3rem;
            text-align: center;
        }

        /* Text Alignment Classes */
        .text-center {
            text-align: center;
        }
    </style>
<script>  
    document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        alert('Автоматическое контекстное меню (по щелчку правой кнопкой мыши) отключено');
    });

    document.addEventListener('selectstart', function(e) {
        e.preventDefault();
    });

    document.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && (e.key === 'c' || e.key === 'u' || e.key === 's' || e.key === 'a')) {
            e.preventDefault();
            alert('Функция копирования отключена.');
        }
    });

    document.addEventListener('keydown', function(e) {
        if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I')) {
            e.preventDefault();
            alert('Инструменты разработчика отключены.');
        }
    });
</script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5020583079217470"crossorigin="anonymous"></script> </head>
<body class="bg-gray-50 min-h-screen flex flex-col font-sans">
    <main class="main">
        <div style="padding: 2rem 0;">
            <h1 class="text-3xl font-bold text-center mb-8">Инструмент фона и маски</h1>
        </div>
        <div class="bg-mask-container">
                    <div class="sidebar-container">
                        <div class="sidebar">
                            <div class="sidebar-content">
                                <div class="upload-section">
                                    <button id="upload-btn" class="upload-btn">
                                        <i class="fas fa-upload"></i> Загрузить изображение
                                    </button>
                                    <input type="file" id="file-input" class="file-input" accept="image/jpeg,image/png,image/webp">
                                </div>

                                <div class="tools-section">
                                    <h2>Инструменты фона<span class="help-icon" title="Примечание: инструменты добавления сплошного/градиентного/узора фона работают только с изображениями, имеющими прозрачный фон. Цвета фона будут видны только в прозрачных областях изображения.">
                                        <i class="fas fa-question-circle"></i>
                                    </span></h2>
                                    <div class="tools-grid">
                                        <button class="tool-btn" data-mode="remove-bg" data-title="Удалить фон изображения онлайн" data-description="Мгновенно удалите сплошной цвет фона из изображений онлайн. Сделайте изображения прозрачными с регулируемым допуском. Идеально подходит для товарных фотографий, логотипов и графики. Загрузите в формате PNG с прозрачным фоном.">
                                            <i class="fas fa-eraser"></i>
                                            <span>Удалить фон</span>
                                        </button>
                                        <button class="tool-btn" data-mode="add-solid-bg" data-title="Добавить цвет фона к изображению" data-description="Добавьте сплошной цвет фона к прозрачным изображениям онлайн. Заполните прозрачные области любым цветом. Лучше всего работает с PNG-изображениями с прозрачностью. Экспорт в формате PNG.">
                                            <i class="fas fa-fill-drip"></i>
                                            <span>Сплошной фон</span>
                                        </button>
                                        <button class="tool-btn" data-mode="add-gradient-bg" data-title="Добавить градиентный фон к изображению" data-description="Добавьте градиентный фон к прозрачным изображениям онлайн. Создавайте красивые цветовые переходы с горизонтальными, вертикальными или диагональными градиентами. Идеально подходит для социальных сетей и дизайн-проектов.">
                                            <i class="fas fa-palette"></i>
                                            <span>Градиент</span>
                                        </button>
                                        <button class="tool-btn" data-mode="add-pattern-bg" data-title="Добавить узорчатый фон к изображению" data-description="Добавьте узорчатый фон к прозрачным изображениям онлайн. Выбирайте из точек, линий, сетки или клетчатых узоров. Настройте цвета под ваш дизайн. Экспорт в формате PNG.">
                                            <i class="fas fa-th"></i>
                                            <span>Узор</span>
                                        </button>
                                        <button class="tool-btn" data-mode="resize-bg-fit" data-title="Изменить размер изображения онлайн" data-description="Измените размер изображения и подгоните под цвет фона. Идеально подходит для создания миниатюр, публикаций в социальных сетях и товарных изображений. Установите пользовательские размеры и цвет фона.">
                                            <i class="fas fa-expand-arrows-alt"></i>
                                            <span>Изменить размер</span>
                                        </button>
                                    </div>
                                </div>

                                <div class="tools-section">
                                    <h2>Инструменты обрезки / маски</h2>
                                    <div class="tools-grid">
                                        <button class="tool-btn" data-mode="crop-foreground" data-title="Обрезать изображение онлайн" data-description="Обрежьте изображение до объекта переднего плана онлайн. Автоматически удалите пустое пространство и обрежьте до основного объекта. Идеально подходит для товарной фотографии и портретов. Загрузите в формате PNG.">
                                            <i class="fas fa-crop"></i>
                                            <span>Обрезка переднего плана</span>
                                        </button>
                                        <button class="tool-btn" data-mode="auto-crop" data-title="Автообрезка изображения" data-description="Автоматически обрежьте прозрачные края онлайн. Удалите пустые прозрачные области из изображений. Идеально подходит для очистки PNG-изображений с избыточной прозрачностью. Экспорт в формате PNG.">
                                            <i class="fas fa-crop-alt"></i>
                                            <span>Автообрезка</span>
                                        </button>
                                        <button class="tool-btn" data-mode="center-crop" data-title="Центральная обрезка изображения онлайн" data-description="Центрируйте объект в области обрезки онлайн. Автоматически обнаруживайте и центрируйте основной объект. Идеально подходит для создания миниатюр и профильных изображений. Установите пользовательские размеры.">
                                            <i class="fas fa-compress-arrows-alt"></i>
                                            <span>Центр</span>
                                        </button>
                                        <button class="tool-btn" data-mode="mask-circle" data-title="Круглая маска для изображения онлайн" data-description="Примените круглую маску к изображению онлайн. Создайте идеальные круглые фотографии и аватары. Настройте размер и положение. Идеально подходит для профильных изображений и социальных сетей. Экспорт в формате PNG.">
                                            <i class="fas fa-circle"></i>
                                            <span>Круг</span>
                                        </button>
                                        <button class="tool-btn" data-mode="mask-square" data-title="Квадратная маска для изображения онлайн" data-description="Примените квадратную маску к изображению онлайн. Создайте квадратные фотографии с закругленными углами. Настройте размер, положение и радиус углов. Идеально подходит для Instagram и социальных сетей. Экспорт в формате PNG.">
                                            <i class="fas fa-square"></i>
                                            <span>Квадрат</span>
                                        </button>
                                        <button class="tool-btn" data-mode="mask-custom" data-title="Пользовательская маска для изображения онлайн" data-description="Примените пользовательскую маску к изображению онлайн. Загрузите собственное изображение маски для создания уникальных форм и эффектов. Идеально подходит для творческих проектов и пользовательских дизайнов. Экспорт в формате PNG.">
                                            <i class="fas fa-draw-polygon"></i>
                                            <span>Пользовательский</span>
                                        </button>
                                        <button class="tool-btn" data-mode="apply-alpha-mask" data-title="Применить альфа-маску к изображению онлайн" data-description="Примените альфа-маску из другого изображения онлайн. Используйте изображение в оттенках серого для контроля прозрачности. Идеально подходит для продвинутого компоновки изображений и творческих эффектов. Экспорт в формате PNG.">
                                            <i class="fas fa-mask"></i>
                                            <span>Альфа</span>
                                        </button>
                                        <button class="tool-btn" data-mode="remove-alpha-mask" data-title="Удалить альфа-маску из изображения онлайн" data-description="Удалите прозрачность и добавьте цвет фона онлайн. Слейте прозрачные изображения с сплошным фоном. Идеально подходит для преобразования PNG в JPG. Выберите любой цвет фона.">
                                            <i class="fas fa-layer-group"></i>
                                            <span>Удалить альфа</span>
                                        </button>
                                    </div>
                                </div>

                                <div class="settings-section" id="settings-section">
                                    <h2>Настройки инструмента</h2>
                                    <div id="dynamic-settings">
                                        <p style="color: #666; font-size: 14px;">Выберите инструмент, чтобы увидеть настройки</p>
                                    </div>
                                </div>

                                <div class="privacy-statement">
                                    <i class="fas fa-shield-alt" style="margin-right: 8px;"></i>
                                    Файлы обрабатываются локально и автоматически удаляются после обработки.
                                </div>
                            </div>

                            <div class="sidebar-actions">
                                <div class="action-row">
                                    <button id="clear-btn" class="action-btn clear-btn">
                                        <i class="fas fa-trash"></i> Очистить все
                                    </button>
                                    <button id="download-btn" class="action-btn download-btn" disabled>
                                        <i class="fas fa-download"></i> Экспорт
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="canvas-area">
                        <div id="upload-prompt" class="upload-prompt">
                            <div class="upload-prompt-icon">
                                <i class="fas fa-image"></i>
                            </div>
                            <div class="upload-prompt-title">Инструмент фона и маски</div>
                            <div class="upload-prompt-instruction">Нажмите здесь или перетащите изображение, чтобы начать обработку</div>
                            <p style="font-size: 14px; color: #666; margin-top: 10px;">Поддерживает: JPG, PNG, WebP</p>
                        </div>

                        <div id="canvas-wrapper" class="canvas-wrapper">
                            <button id="delete-image-btn" class="delete-image-btn" title="Удалить изображение">
                                <i class="fas fa-times"></i>
                            </button>
                            <canvas id="resultCanvas"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <!-- Tutorial Section -->
    <section class="tutorial-section">
        <div class="container">
            <h2 class="text-4xl">Как использовать инструмент фона и маски</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4">
                <!-- Step 1 -->
                <div class="tutorial-card">
                    <h3>
                        <span class="tutorial-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </span>
                        Загрузка изображения
                    </h3>
                    <p title="Перетащите изображение непосредственно в область загрузки или нажмите кнопку загрузки, чтобы выбрать файл с устройства. Поддерживает форматы JPG, PNG и WebP.">Перетащите изображение непосредственно в область загрузки или нажмите кнопку загрузки, чтобы выбрать файл с устройства. Поддерживает форматы JPG, PNG и WebP.</p>
                </div>
                <!-- Step 2 -->
                <div class="tutorial-card">
                    <h3>
                        <span class="tutorial-icon">
                            <i class="fas fa-magic"></i>
                        </span>
                        Выбор инструмента
                    </h3>
                    <p title="Выбирайте из 13 инструментов фона и маски, включая удаление фона, добавление сплошного/градиентного/узора фона, обрезку, автообрезку, центральную обрезку, круглую/квадратную/пользовательскую маску, применение/удаление альфа-маски и изменение размера + подгонка фона.">Выбирайте из 13 инструментов фона и маски, включая удаление фона, добавление сплошного/градиентного/узора фона, обрезку, автообрезку, центральную обрезку, круглую/квадратную/пользовательскую маску, применение/удаление альфа-маски и изменение размера + подгонка фона.</p>
                </div>
                <!-- Step 3 -->
                <div class="tutorial-card">
                    <h3>
                        <span class="tutorial-icon">
                            <i class="fas fa-sliders-h"></i>
                        </span>
                        Настройка параметров
                    </h3>
                    <p title="Настройте параметры инструмента, включая выбор цвета, уровень допуска, направление градиента, размер маски и другие параметры в зависимости от выбранного инструмента.">Настройте параметры инструмента, включая выбор цвета, уровень допуска, направление градиента, размер маски и другие параметры в зависимости от выбранного инструмента.</p>
                </div>
                <!-- Step 4 -->
                <div class="tutorial-card">
                    <h3>
                        <span class="tutorial-icon">
                            <i class="fas fa-download"></i>
                        </span>
                        Экспорт изображения
                    </h3>
                    <p title="Нажмите кнопку Экспорт, чтобы загрузить обработанное изображение в формате PNG. Все операции с фоном и маской применяются к вашему изображению.">Нажмите кнопку Экспорт, чтобы загрузить обработанное изображение в формате PNG. Все операции с фоном и маской применяются к вашему изображению.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Feature Introduction Section -->
    <section class="feature-section">
        <div class="container">
            <div class="grid-cols-2">
                <div class="content-image">
                    <img src="https://images.unsplash.com/photo-1476820865390-c52aeebb9891?w=600&h=400&fit=crop" alt="Background & Mask Tool" class="rounded-xl shadow-2xl w-full">
                </div>
                <div class="content-text">
                    <h2>Профессиональная обработка фона и маски</h2>
                    <p>Обрабатывайте фоны и маски изображений с точностью и легкостью. Наш инструмент предоставляет 13 профессиональных инструментов фона и маски, чтобы помочь вам удалять фоны, добавлять цвета, применять маски и многое другое.</p>
                    <p>Идеально подходит для электронной коммерции, социальных сетей, фотографии и любых изображений, которым требуется обработка фона или маски.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Tool Features Section -->
    <section class="feature-section gray">
        <div class="container">
            <div class="grid-cols-2">
                <div class="content-text order-2 md:order-1">
                    <h2>Мощные инструменты фона</h2>
                    <p>От простого удаления фона до продвинутых градиентных и узорчатых фонов, наш инструмент имеет все необходимое для профессиональной обработки фонов изображений.</p>
                    <p>Удаляйте сплошные фоны, добавляйте прозрачные или цветные фоны, применяйте различные маски и обрезайте изображения, чтобы сосредоточиться на вашем объекте.</p>
                </div>
                <div class="content-image order-1 md:order-2">
                    <img src="https://plus.unsplash.com/premium_photo-1674984909531-7b3ac0035e60?w=600&h=400&fit=crop" alt="Background Tools" class="rounded-xl shadow-2xl w-full">
                </div>
            </div>
        </div>
    </section>
    
    <!-- Privacy & Security Section -->
    <section class="feature-section">
        <div class="container">
            <div class="grid-cols-2">
                <div class="content-image">
                    <img src="https://images.unsplash.com/photo-1553984840-b8cbc34f5215?w=600&h=400&fit=crop" alt="Privacy Protection" class="rounded-xl shadow-2xl w-full">
                </div>
                <div class="content-text">
                    <h2>100% защита конфиденциальности</h2>
                    <p>Вся обработка изображений происходит локально в вашем браузере. Ваши изображения никогда не загружаются на какие-либо серверы.</p>
                    <p>Ваши данные остаются на вашем устройстве, обеспечивая полную конфиденциальность и безопасность для чувствительных изображений.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Mobile Support Section -->
    <section class="feature-section gray">
        <div class="container">
            <div class="grid-cols-2">
                <div class="content-text order-2 md:order-1">
                    <h2>Мобильная версия</h2>
                    <p>Обрабатывайте фоны и маски в движении с помощью нашего мобильного дизайна. Наш инструмент отлично работает на смартфонах и планшетах.</p>
                    <p>С адаптивным интерфейсом, который подстраивается под любой размер экрана, вы можете легко загружать, обрабатывать и скачивать изображения с помощью вашего мобильного устройства.</p>
                </div>
                <div class="content-image order-1 md:order-2">
                    <img src="https://images.unsplash.com/photo-1476514525535-07fb3b4ae5f1?w=600&h=400&fit=crop" alt="Mobile-Friendly Design" class="rounded-xl shadow-2xl w-full">
                </div>
            </div>
        </div>
    </section>

    <!-- Bottom Text Area -->
    <section class="bottom-text-section">
        <div class="container">
            <h2>Легкая обработка фона и маски бесплатно</h2>
            <p>Попрощайтесь с использованием сложного программного обеспечения для обработки фонов и масок изображений. С помощью CaliperTools Background & Mask вы можете без усилий добавлять профессиональные фоны и маски к вашим изображениям бесплатно. Лучшая часть заключается в том, что вы можете использовать наш инструмент с любого устройства с браузером, никаких загрузок или установок не требуется. Опыт не нужен!</p>
            <p class="mb-10">Используйте редактор перетаскивания для загрузки ваших изображений, а CaliperTools Background & Mask выполнит остальную работу. Когда закончите, скачайте ваши обработанные изображения в формате PNG. Обрабатывайте столько картинок, сколько хотите, все это за несколько кликов.</p>
            
            <h2>Высококачественная обработка каждый раз</h2>
            <p>Сохраняйте качество ваших изображений при добавлении профессиональных фонов и масок. Наши передовые инструменты обеспечивают сохранение четкости и деталей ваших изображений, будь то удаление фонов, добавление цветов или применение масок.</p>
            <p>С нашими встроенными возможностями настройки вы можете регулировать цвета, допуски и размеры, и выбирать из 13 различных инструментов фона и маски, чтобы сделать ваши изображения выдающимися. Улучшайте свои фотографии и повышайте эффективность коммуникации с идеально обработанными изображениями.</p>
        </div>
    </section>

    <!-- Related Tools Section -->
    <section class="section related-tools py-16 bg-white">
        <div class="container mx-auto px-6 max-w-[1400px]">
            <h2 class="section-title text-3xl font-bold text-gray-900 mb-12 text-center">Связанные инструменты</h2>
            <div class="tools-grid" id="relatedTools">
            </div>
        </div>
    </section>

    </main>

    <!-- Footer Container -->
    <div id="footer-container"></div>

    <!-- Related Tools Script -->
    <script src="../scripts/script-related-tools.js"></script>
    <script>
        // Initialize related tools
        document.addEventListener('DOMContentLoaded', function() {
            const currentSlug = 'image-background-mask-tool';
            if (typeof initRelatedTools === 'function') {
                initRelatedTools(currentSlug);
            }
        });
    </script>

    <script>
        let resultCanvas, resultCtx;
        let originalImage = null;
        let currentMode = null;
        let currentSettings = {};
        let displayWidth = 0;
        let displayHeight = 0;

        const uploadBtn = document.getElementById('upload-btn');
        const fileInput = document.getElementById('file-input');
        const uploadPrompt = document.getElementById('upload-prompt');
        const canvasWrapper = document.getElementById('canvas-wrapper');
        const deleteImageBtn = document.getElementById('delete-image-btn');
        const clearBtn = document.getElementById('clear-btn');
        const downloadBtn = document.getElementById('download-btn');
        const toolButtons = document.querySelectorAll('.tool-btn');
        const dynamicSettings = document.getElementById('dynamic-settings');

        const settingsTemplates = {
            'remove-bg': `
                <div class="setting-row">
                    <span class="setting-label">Целевой цвет:</span>
                    <input type="color" id="setting-target-color" class="color-picker" value="#ffffff">
                </div>
                <div class="setting-row">
                    <span class="setting-label">Допуск:</span>
                    <input type="range" id="setting-tolerance" class="size-slider" min="0" max="100" value="20">
                    <span id="tolerance-display" class="size-display">20%</span>
                </div>
            `,
            'add-solid-bg': `
                <div class="setting-row">
                    <span class="setting-label">Background:</span>
                    <input type="color" id="setting-bg-color" class="color-picker" value="#ffffff">
                    <span class="help-icon" title="Этот инструмент работает только с изображениями с прозрачным фоном. Цвет фона будет виден только в прозрачных областях изображения.">
                        <i class="fas fa-question-circle"></i>
                    </span>
                </div>
            `,
            'add-gradient-bg': `
                <div class="setting-row">
                    <span class="setting-label">Начальный цвет:</span>
                    <input type="color" id="setting-gradient-start" class="color-picker" value="#ffffff">
                </div>
                <div class="setting-row">
                    <span class="setting-label">Конечный цвет:</span>
                    <input type="color" id="setting-gradient-end" class="color-picker" value="#000000">
                    <span class="help-icon" title="Этот инструмент работает только с изображениями с прозрачным фоном. Градиентный фон будет виден только в прозрачных областях изображения.">
                        <i class="fas fa-question-circle"></i>
                    </span>
                </div>
                <div class="setting-row">
                    <span class="setting-label">Direction:</span>
                    <select id="setting-gradient-direction" class="setting-select">
                        <option value="horizontal">Horizontal</option>
                        <option value="vertical">Vertical</option>
                        <option value="diagonal">Diagonal</option>
                    </select>
                </div>
            `,
            'add-pattern-bg': `
                <div class="setting-row">
                    <span class="setting-label">Pattern:</span>
                    <select id="setting-pattern" class="setting-select">
                        <option value="dots">Dots</option>
                        <option value="lines">Lines</option>
                        <option value="grid">Grid</option>
                        <option value="checkerboard">Checkerboard</option>
                    </select>
                </div>
                <div class="setting-row">
                    <span class="setting-label">Color 1:</span>
                    <input type="color" id="setting-pattern-color1" class="color-picker" value="#ffffff">
                </div>
                <div class="setting-row">
                    <span class="setting-label">Color 2:</span>
                    <input type="color" id="setting-pattern-color2" class="color-picker" value="#000000">
                </div>
            `,
            'resize-bg-fit': `
                <div class="setting-row">
                    <span class="setting-label">Width:</span>
                    <input type="number" id="setting-width" class="setting-input" value="800" min="100" max="4000">
                </div>
                <div class="setting-row">
                    <span class="setting-label">Height:</span>
                    <input type="number" id="setting-height" class="setting-input" value="600" min="100" max="4000">
                </div>
                <div class="setting-row">
                    <span class="setting-label">Background:</span>
                    <input type="color" id="setting-bg-color" class="color-picker" value="#ffffff">
                </div>
            `,
            'crop-foreground': `
                <p style="color: #666; font-size: 14px;">This tool will crop the image to the foreground object.</p>
            `,
            'auto-crop': `
                <p style="color: #666; font-size: 14px;">This tool will auto crop transparent edges.</p>
            `,
            'center-crop': `
                <div class="setting-row">
                    <span class="setting-label">Width:</span>
                    <input type="number" id="setting-width" class="setting-input" value="800" min="100" max="4000">
                </div>
                <div class="setting-row">
                    <span class="setting-label">Height:</span>
                    <input type="number" id="setting-height" class="setting-input" value="600" min="100" max="4000">
                </div>
            `,
            'mask-circle': `
                <div class="setting-row">
                    <span class="setting-label">Size:</span>
                    <input type="range" id="setting-mask-size" class="size-slider" min="50" max="500" value="200">
                    <span id="mask-size-display" class="size-display">200px</span>
                </div>
                <div class="setting-row">
                    <span class="setting-label">Position:</span>
                    <select id="setting-mask-position" class="setting-select">
                        <option value="center">Center</option>
                        <option value="top-left">Top Left</option>
                        <option value="top-right">Top Right</option>
                        <option value="bottom-left">Bottom Left</option>
                        <option value="bottom-right">Bottom Right</option>
                    </select>
                </div>
            `,
            'mask-square': `
                <div class="setting-row">
                    <span class="setting-label">Size:</span>
                    <input type="range" id="setting-mask-size" class="size-slider" min="50" max="500" value="200">
                    <span id="mask-size-display" class="size-display">200px</span>
                </div>
                <div class="setting-row">
                    <span class="setting-label">Position:</span>
                    <select id="setting-mask-position" class="setting-select">
                        <option value="center">Center</option>
                        <option value="top-left">Top Left</option>
                        <option value="top-right">Top Right</option>
                        <option value="bottom-left">Bottom Left</option>
                        <option value="bottom-right">Bottom Right</option>
                    </select>
                </div>
                <div class="setting-row">
                    <span class="setting-label">Corner Radius:</span>
                    <input type="range" id="setting-corner-radius" class="size-slider" min="0" max="100" value="0">
                    <span id="corner-radius-display" class="size-display">0px</span>
                </div>
            `,
            'mask-custom': `
                <p style="color: #666; font-size: 14px;">Upload a custom mask image to apply.</p>
                <div class="setting-row">
                    <span class="setting-label">Mask Image:</span>
                    <input type="file" id="mask-custom-file" class="file-input" accept="image/png,image/jpeg">
                    <button class="file-upload-btn" onclick="document.getElementById('mask-custom-file').click()">
                        <i class="fas fa-upload"></i> Choose File
                    </button>
                    <span id="mask-custom-file-name" class="file-name">No file chosen</span>
                </div>
            `,
            'apply-alpha-mask': `
                <p style="color: #666; font-size: 14px;">Upload a mask image to use as alpha channel.</p>
                <div class="setting-row">
                    <span class="setting-label">Mask Image:</span>
                    <input type="file" id="alpha-mask-file" class="file-input" accept="image/png,image/jpeg">
                    <button class="file-upload-btn" onclick="document.getElementById('alpha-mask-file').click()">
                        <i class="fas fa-upload"></i> Choose File
                    </button>
                    <span id="alpha-mask-file-name" class="file-name">No file chosen</span>
                </div>
            `,
            'remove-alpha-mask': `
                <div class="setting-row">
                    <span class="setting-label">Background:</span>
                    <input type="color" id="setting-bg-color" class="color-picker" value="#ffffff">
                </div>
            `
        };

        function getSettingValue(id) {
            const element = document.getElementById(id);
            console.log('getSettingValue - ID:', id, 'Element:', element, 'Value:', element ? element.value : 'null');
            return element ? element.value : null;
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }

        function updateSettingsPanel(mode) {
            if (settingsTemplates[mode]) {
                dynamicSettings.innerHTML = settingsTemplates[mode];
                console.log('Settings panel updated for mode:', mode);
                
                if (mode === 'add-solid-bg') {
                    canvasWrapper.style.backgroundColor = '#ffffff';
                } else {
                    canvasWrapper.style.backgroundColor = 'transparent';
                }
                
                setTimeout(function() {
                    processImages();
                }, 100);
            } else {
                dynamicSettings.innerHTML = '<p style="color: #666; font-size: 14px;">No settings for this mode</p>';
            }
        }

        function processImages() {
            if (!currentMode) return;
            
            if (!originalImage) {
                console.log('No image loaded yet');
                return;
            }

            console.log('Processing mode:', currentMode);
            console.log('Display dimensions:', displayWidth, 'x', displayHeight);
            console.log('Canvas dimensions:', resultCanvas.width, 'x', resultCanvas.height);
            
            resultCanvas.width = displayWidth;
            resultCanvas.height = displayHeight;

            console.log('Switching to case:', currentMode);
            switch (currentMode) {
                case 'remove-bg':
                    console.log('Calling processRemoveBackground');
                    processRemoveBackground();
                    break;
                case 'add-solid-bg':
                    console.log('Calling processAddSolidBackground');
                    processAddSolidBackground();
                    break;
                case 'add-gradient-bg':
                    processAddGradientBackground();
                    break;
                case 'add-pattern-bg':
                    processAddPatternBackground();
                    break;
                case 'resize-bg-fit':
                    processResizeBackgroundFit();
                    break;
                case 'crop-foreground':
                    processCropForeground();
                    break;
                case 'auto-crop':
                    processAutoCrop();
                    break;
                case 'center-crop':
                    processCenterCrop();
                    break;
                case 'mask-circle':
                    processMaskCircle();
                    break;
                case 'mask-square':
                    processMaskSquare();
                    break;
                case 'mask-custom':
                    processMaskCustom();
                    break;
                case 'apply-alpha-mask':
                    processApplyAlphaMask();
                    break;
                case 'remove-alpha-mask':
                    processRemoveAlphaMask();
                    break;
            }

            downloadBtn.disabled = false;
        }

        function processRemoveBackground() {
            console.log('Processing Remove Background');
            const targetColor = hexToRgb(getSettingValue('setting-target-color'));
            const tolerance = parseInt(getSettingValue('setting-tolerance')) || 20;
            console.log('Target color:', targetColor, 'Tolerance:', tolerance);
            console.log('Canvas size:', resultCanvas.width, 'x', resultCanvas.height);

            resultCtx.drawImage(originalImage, 0, 0, displayWidth, displayHeight);
            const imageData = resultCtx.getImageData(0, 0, resultCanvas.width, resultCanvas.height);
            const data = imageData.data;

            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];

                const dr = Math.abs(r - targetColor.r);
                const dg = Math.abs(g - targetColor.g);
                const db = Math.abs(b - targetColor.b);

                if (dr + dg + db < tolerance * 3) {
                    data[i + 3] = 0;
                }
            }

            resultCtx.putImageData(imageData, 0, 0);
            console.log('Remove Background completed');
        }

        function processAddSolidBackground() {
            const bgColor = getSettingValue('setting-bg-color') || '#ffffff';
            console.log('Add Solid Background - Background color:', bgColor);
            console.log('Canvas size:', resultCanvas.width, 'x', resultCanvas.height);
            console.log('Display size:', displayWidth, 'x', displayHeight);
            console.log('Original image size:', originalImage.width, 'x', originalImage.height);
            
            resultCtx.clearRect(0, 0, resultCanvas.width, resultCanvas.height);
            resultCtx.fillStyle = bgColor;
            resultCtx.fillRect(0, 0, resultCanvas.width, resultCanvas.height);
            
            resultCtx.drawImage(originalImage, 0, 0, displayWidth, displayHeight);
            
            console.log('Canvas data URL:', resultCanvas.toDataURL('image/png').substring(0, 100));
            console.log('Add Solid Background completed');
        }

        function processAddGradientBackground() {
            const startColor = getSettingValue('setting-gradient-start') || '#ffffff';
            const endColor = getSettingValue('setting-gradient-end') || '#000000';
            const direction = getSettingValue('setting-gradient-direction') || 'horizontal';
            
            console.log('Add Gradient Background - Start color:', startColor, 'End color:', endColor, 'Direction:', direction);

            let gradient;
            if (direction === 'horizontal') {
                gradient = resultCtx.createLinearGradient(0, 0, resultCanvas.width, 0);
            } else if (direction === 'vertical') {
                gradient = resultCtx.createLinearGradient(0, 0, 0, resultCanvas.height);
            } else {
                gradient = resultCtx.createLinearGradient(0, 0, resultCanvas.width, resultCanvas.height);
            }

            gradient.addColorStop(0, startColor);
            gradient.addColorStop(1, endColor);

            resultCtx.fillStyle = gradient;
            resultCtx.fillRect(0, 0, resultCanvas.width, resultCanvas.height);
            resultCtx.drawImage(originalImage, 0, 0, displayWidth, displayHeight);
            
            console.log('Add Gradient Background completed');
        }

        function processAddPatternBackground() {
            const pattern = getSettingValue('setting-pattern') || 'dots';
            const color1 = getSettingValue('setting-pattern-color1') || '#ffffff';
            const color2 = getSettingValue('setting-pattern-color2') || '#000000';

            resultCtx.fillStyle = color1;
            resultCtx.fillRect(0, 0, resultCanvas.width, resultCanvas.height);

            const patternCanvas = document.createElement('canvas');
            patternCanvas.width = 20;
            patternCanvas.height = 20;
            const patternCtx = patternCanvas.getContext('2d');

            if (pattern === 'dots') {
                patternCtx.fillStyle = color2;
                patternCtx.beginPath();
                patternCtx.arc(10, 10, 3, 0, Math.PI * 2);
                patternCtx.fill();
            } else if (pattern === 'lines') {
                patternCtx.strokeStyle = color2;
                patternCtx.lineWidth = 2;
                patternCtx.beginPath();
                patternCtx.moveTo(0, 10);
                patternCtx.lineTo(20, 10);
                patternCtx.stroke();
            } else if (pattern === 'grid') {
                patternCtx.strokeStyle = color2;
                patternCtx.lineWidth = 1;
                patternCtx.strokeRect(0, 0, 20, 20);
            } else if (pattern === 'checkerboard') {
                patternCtx.fillStyle = color2;
                patternCtx.fillRect(0, 0, 10, 10);
                patternCtx.fillRect(10, 10, 10, 10);
            }

            const createdPattern = resultCtx.createPattern(patternCanvas, 'repeat');
            resultCtx.fillStyle = createdPattern;
            resultCtx.fillRect(0, 0, resultCanvas.width, resultCanvas.height);
            resultCtx.drawImage(originalImage, 0, 0, displayWidth, displayHeight);
        }

        function processResizeBackgroundFit() {
            const targetWidth = parseInt(getSettingValue('setting-width')) || 800;
            const targetHeight = parseInt(getSettingValue('setting-height')) || 600;
            const bgColor = getSettingValue('setting-bg-color') || '#ffffff';

            resultCanvas.width = targetWidth;
            resultCanvas.height = targetHeight;

            resultCtx.fillStyle = bgColor;
            resultCtx.fillRect(0, 0, targetWidth, targetHeight);

            const scale = Math.min(targetWidth / originalImage.width, targetHeight / originalImage.height);
            const newWidth = originalImage.width * scale;
            const newHeight = originalImage.height * scale;
            const x = (targetWidth - newWidth) / 2;
            const y = (targetHeight - newHeight) / 2;

            resultCtx.drawImage(originalImage, x, y, newWidth, newHeight);
        }

        function processCropForeground() {
            resultCtx.drawImage(originalImage, 0, 0, displayWidth, displayHeight);
            const imageData = resultCtx.getImageData(0, 0, resultCanvas.width, resultCanvas.height);
            const data = imageData.data;

            let minX = resultCanvas.width, minY = resultCanvas.height;
            let maxX = 0, maxY = 0;
            let hasContent = false;

            for (let y = 0; y < resultCanvas.height; y++) {
                for (let x = 0; x < resultCanvas.width; x++) {
                    const i = (y * resultCanvas.width + x) * 4;
                    if (data[i + 3] > 0) {
                        hasContent = true;
                        minX = Math.min(minX, x);
                        minY = Math.min(minY, y);
                        maxX = Math.max(maxX, x);
                        maxY = Math.max(maxY, y);
                    }
                }
            }

            if (hasContent) {
                const croppedWidth = maxX - minX + 1;
                const croppedHeight = maxY - minY + 1;

                const croppedData = resultCtx.getImageData(minX, minY, croppedWidth, croppedHeight);
                resultCanvas.width = croppedWidth;
                resultCanvas.height = croppedHeight;
                resultCtx.putImageData(croppedData, 0, 0);
            }
        }

        function processAutoCrop() {
            resultCtx.drawImage(originalImage, 0, 0, displayWidth, displayHeight);
            const imageData = resultCtx.getImageData(0, 0, resultCanvas.width, resultCanvas.height);
            const data = imageData.data;

            let minX = resultCanvas.width, minY = resultCanvas.height;
            let maxX = 0, maxY = 0;
            let hasContent = false;

            for (let y = 0; y < resultCanvas.height; y++) {
                for (let x = 0; x < resultCanvas.width; x++) {
                    const i = (y * resultCanvas.width + x) * 4;
                    if (data[i + 3] > 0) {
                        hasContent = true;
                        minX = Math.min(minX, x);
                        minY = Math.min(minY, y);
                        maxX = Math.max(maxX, x);
                        maxY = Math.max(maxY, y);
                    }
                }
            }

            if (hasContent) {
                const croppedWidth = maxX - minX + 1;
                const croppedHeight = maxY - minY + 1;

                const croppedData = resultCtx.getImageData(minX, minY, croppedWidth, croppedHeight);
                resultCanvas.width = croppedWidth;
                resultCanvas.height = croppedHeight;
                resultCtx.putImageData(croppedData, 0, 0);
            }
        }

        function processCenterCrop() {
            const targetWidth = parseInt(getSettingValue('setting-width')) || 800;
            const targetHeight = parseInt(getSettingValue('setting-height')) || 600;
            
            console.log('Center Crop - Target size:', targetWidth, 'x', targetHeight);
            console.log('Center Crop - Display size:', displayWidth, 'x', displayHeight);
            console.log('Center Crop - Original size:', originalImage.width, 'x', originalImage.height);

            resultCanvas.width = displayWidth;
            resultCanvas.height = displayHeight;
            resultCtx.drawImage(originalImage, 0, 0, displayWidth, displayHeight);

            const imageData = resultCtx.getImageData(0, 0, resultCanvas.width, resultCanvas.height);
            const data = imageData.data;

            let minX = resultCanvas.width, minY = resultCanvas.height;
            let maxX = 0, maxY = 0;
            let hasContent = false;

            for (let y = 0; y < resultCanvas.height; y++) {
                for (let x = 0; x < resultCanvas.width; x++) {
                    const i = (y * resultCanvas.width + x) * 4;
                    if (data[i + 3] > 0) {
                        hasContent = true;
                        minX = Math.min(minX, x);
                        minY = Math.min(minY, y);
                        maxX = Math.max(maxX, x);
                        maxY = Math.max(maxY, y);
                    }
                }
            }

            console.log('Center Crop - Bounding box:', minX, minY, maxX, maxY, 'Has content:', hasContent);

            if (hasContent) {
                const objectWidth = maxX - minX + 1;
                const objectHeight = maxY - minY + 1;

                resultCanvas.width = targetWidth;
                resultCanvas.height = targetHeight;

                const scale = Math.min(targetWidth / objectWidth, targetHeight / objectHeight);
                const scaledObjectWidth = objectWidth * scale;
                const scaledObjectHeight = objectHeight * scale;

                const x = (targetWidth - scaledObjectWidth) / 2;
                const y = (targetHeight - scaledObjectHeight) / 2;

                const scaleX = originalImage.width / displayWidth;
                const scaleY = originalImage.height / displayHeight;

                console.log('Center Crop - Object size:', objectWidth, 'x', objectHeight);
                console.log('Center Crop - Scale:', scale);
                console.log('Center Crop - Scaled object size:', scaledObjectWidth, 'x', scaledObjectHeight);
                console.log('Center Crop - Position:', x, y);

                resultCtx.drawImage(originalImage, 
                    minX * scaleX, 
                    minY * scaleY, 
                    objectWidth * scaleX, 
                    objectHeight * scaleY,
                    x, y, scaledObjectWidth, scaledObjectHeight
                );
            } else {
                console.log('Center Crop - No content found, using full image');
                
                resultCanvas.width = targetWidth;
                resultCanvas.height = targetHeight;
                
                const scale = Math.min(targetWidth / originalImage.width, targetHeight / originalImage.height);
                const newWidth = originalImage.width * scale;
                const newHeight = originalImage.height * scale;
                const x = (targetWidth - newWidth) / 2;
                const y = (targetHeight - newHeight) / 2;
                
                console.log('Center Crop - Scale:', scale);
                console.log('Center Crop - New size:', newWidth, 'x', newHeight);
                console.log('Center Crop - Position:', x, y);
                
                resultCtx.drawImage(originalImage, x, y, newWidth, newHeight);
            }
            
            console.log('Center Crop - Result canvas size:', resultCanvas.width, 'x', resultCanvas.height);
        }

        function processMaskCircle() {
            const maskSize = parseInt(getSettingValue('setting-mask-size')) || 200;
            const position = getSettingValue('setting-mask-position') || 'center';

            let x, y;
            if (position === 'center') {
                x = (resultCanvas.width - maskSize) / 2;
                y = (resultCanvas.height - maskSize) / 2;
            } else if (position === 'top-left') {
                x = 0;
                y = 0;
            } else if (position === 'top-right') {
                x = resultCanvas.width - maskSize;
                y = 0;
            } else if (position === 'bottom-left') {
                x = 0;
                y = resultCanvas.height - maskSize;
            } else if (position === 'bottom-right') {
                x = resultCanvas.width - maskSize;
                y = resultCanvas.height - maskSize;
            }

            resultCtx.save();
            resultCtx.beginPath();
            resultCtx.arc(x + maskSize / 2, y + maskSize / 2, maskSize / 2, 0, Math.PI * 2);
            resultCtx.clip();
            resultCtx.drawImage(originalImage, 0, 0, displayWidth, displayHeight);
            resultCtx.restore();
        }

        function processMaskSquare() {
            const maskSize = parseInt(getSettingValue('setting-mask-size')) || 200;
            const position = getSettingValue('setting-mask-position') || 'center';
            const cornerRadius = parseInt(getSettingValue('setting-corner-radius')) || 0;

            let x, y;
            if (position === 'center') {
                x = (resultCanvas.width - maskSize) / 2;
                y = (resultCanvas.height - maskSize) / 2;
            } else if (position === 'top-left') {
                x = 0;
                y = 0;
            } else if (position === 'top-right') {
                x = resultCanvas.width - maskSize;
                y = 0;
            } else if (position === 'bottom-left') {
                x = 0;
                y = resultCanvas.height - maskSize;
            } else if (position === 'bottom-right') {
                x = resultCanvas.width - maskSize;
                y = resultCanvas.height - maskSize;
            }

            resultCtx.save();
            resultCtx.beginPath();
            resultCtx.roundRect(x, y, maskSize, maskSize, cornerRadius);
            resultCtx.clip();
            resultCtx.drawImage(originalImage, 0, 0, displayWidth, displayHeight);
            resultCtx.restore();
        }

        function processMaskCustom() {
            if (!maskCustomImage) {
                console.log('Custom mask - requires uploading a mask image');
                resultCtx.drawImage(originalImage, 0, 0);
                return;
            }
            
            resultCanvas.width = displayWidth;
            resultCanvas.height = displayHeight;
            
            resultCtx.save();
            resultCtx.drawImage(maskCustomImage, 0, 0, displayWidth, displayHeight);
            resultCtx.globalCompositeOperation = 'destination-in';
            resultCtx.drawImage(originalImage, 0, 0, displayWidth, displayHeight);
            resultCtx.restore();
            
            console.log('Custom mask applied');
        }

        function processApplyAlphaMask() {
            if (!alphaMaskImage) {
                console.log('Apply Alpha Mask - requires uploading a mask image');
                resultCtx.drawImage(originalImage, 0, 0, displayWidth, displayHeight);
                return;
            }
            
            resultCanvas.width = displayWidth;
            resultCanvas.height = displayHeight;
            
            const maskCanvas = document.createElement('canvas');
            maskCanvas.width = displayWidth;
            maskCanvas.height = displayHeight;
            const maskCtx = maskCanvas.getContext('2d');
            
            maskCtx.drawImage(alphaMaskImage, 0, 0, displayWidth, displayHeight);
            const maskImageData = maskCtx.getImageData(0, 0, displayWidth, displayHeight);
            const maskData = maskImageData.data;
            
            resultCtx.drawImage(originalImage, 0, 0, displayWidth, displayHeight);
            const imageData = resultCtx.getImageData(0, 0, displayWidth, displayHeight);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const gray = (maskData[i] + maskData[i + 1] + maskData[i + 2]) / 3;
                data[i + 3] = gray;
            }
            
            resultCtx.putImageData(imageData, 0, 0);
            console.log('Alpha mask applied');
        }

        function processRemoveAlphaMask() {
            const bgColor = getSettingValue('setting-bg-color') || '#ffffff';
            
            resultCtx.fillStyle = bgColor;
            resultCtx.fillRect(0, 0, resultCanvas.width, resultCanvas.height);
            resultCtx.drawImage(originalImage, 0, 0);
        }

        function handleUrlParams() {
            // 从哈希值中获取工具名称
            const hash = window.location.hash.substring(1); //移除#符号
            
            if (hash) {
                const modeBtn = document.querySelector(`.tool-btn[data-mode="${hash}"]`);
                if (modeBtn) {
                    modeBtn.click();
                }
            }
        }

        function init() {
            resultCanvas = document.getElementById('resultCanvas');
            resultCtx = resultCanvas.getContext('2d');
            setupEventListeners();
            handleUrlParams();
        }

        function setupEventListeners() {
            uploadBtn.addEventListener('click', function() {
                fileInput.click();
            });
            uploadPrompt.addEventListener('click', function() {
                fileInput.click();
            });
            fileInput.addEventListener('change', handleFileUpload);

            const canvasArea = document.querySelector('.canvas-area');
            canvasArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadPrompt.classList.add('drag-over');
            });

            canvasArea.addEventListener('dragleave', function() {
                uploadPrompt.classList.remove('drag-over');
            });

            canvasArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadPrompt.classList.remove('drag-over');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    loadImage(files[0]);
                }
            });

            deleteImageBtn.addEventListener('click', function() {
                originalImage = null;
                displayWidth = 0;
                displayHeight = 0;
                uploadPrompt.style.display = 'flex';
                canvasWrapper.classList.remove('active');
                downloadBtn.disabled = true;
                resultCtx.clearRect(0, 0, resultCanvas.width, resultCanvas.height);
                
                document.title = 'Background & Mask Tool | CaliperTools';
                const metaDescription = document.querySelector('meta[name="description"]');
                if (metaDescription) {
                    metaDescription.setAttribute('content', 'Process image backgrounds and masks with 13 professional tools. Remove backgrounds, add colors, apply masks, and more. No upload required.');
                }
                
                const newUrl = new URL(window.location.href);
                //确保无论当前URL是什么，都返回正确的基础URL
                const segments = newUrl.pathname.split('/');
                //找到Image目录的位置
                const imageIndex = segments.indexOf('Image');
                if (imageIndex !== -1) {
                    //构建正确的路径：/Image/Image-Background-Mask.html
                    newUrl.pathname = segments.slice(0, imageIndex + 1).join('/') + '/Image-Background-Mask.html';
                } else {
                    //  fallback：如果找不到Image目录，直接使用根目录
                    newUrl.pathname = '/Image/Image-Background-Mask.html';
                }
                newUrl.hash = ''; //移除哈希值
                window.history.pushState({}, '', newUrl);
                
                toolButtons.forEach(function(b) {
                    b.classList.remove('active');
                });
                currentMode = null;
            });

            toolButtons.forEach(function(btn) {
                btn.addEventListener('click', function() {
                    const mode = btn.dataset.mode;
                    console.log('Button clicked:', mode);
                    
                    toolButtons.forEach(function(b) {
                        b.classList.remove('active');
                    });
                    btn.classList.add('active');
                    currentMode = mode;
                    
                    const toolTitle = btn.dataset.title;
                    const toolDescription = btn.dataset.description;
                    
                    if (toolTitle) {
                        document.title = toolTitle + ' | CaliperTools';
                    }
                    
                    const newUrl = new URL(window.location.href);
                    //直接构建正确的路径，不依赖当前URL结构
                    const segments = newUrl.pathname.split('/');
                    //找到Image目录的位置
                    const imageIndex = segments.indexOf('Image');
                    if (imageIndex !== -1) {
                        //构建正确的路径：/Image/Image-Background-Mask.html
                        newUrl.pathname = segments.slice(0, imageIndex + 1).join('/') + '/Image-Background-Mask.html';
                    } else {
                        //  fallback：如果找不到Image目录，直接使用根目录
                        newUrl.pathname = '/Image/Image-Background-Mask.html';
                    }
                    // 使用哈希值而不是路径来表示工具
                    newUrl.hash = mode;
                    window.history.pushState({}, '', newUrl);
                    
                    const metaDescription = document.querySelector('meta[name="description"]');
                    if (metaDescription && toolDescription) {
                        metaDescription.setAttribute('content', toolDescription);
                    }
                    
                    updateSettingsPanel(mode);
                    processImages();
                });
            });

            document.addEventListener('change', function(e) {
                if (e.target.id.startsWith('setting-')) {
                    if (e.target.type !== 'color' && e.target.type !== 'range') {
                        console.log('Change event triggered:', e.target.id, e.target.value);
                        processImages();
                    }
                }
                if (e.target.id === 'mask-custom-file') {
                    handleMaskCustomUpload(e.target.files[0]);
                }
                if (e.target.id === 'alpha-mask-file') {
                    handleAlphaMaskUpload(e.target.files[0]);
                }
            });

            document.addEventListener('input', function(e) {
                console.log('Input event triggered:', e.target.id, e.target.value, e.target.type);
                
                if (e.target.id === 'setting-tolerance') {
                    document.getElementById('tolerance-display').textContent = e.target.value + '%';
                    processImages();
                }
                if (e.target.id === 'setting-mask-size') {
                    document.getElementById('mask-size-display').textContent = e.target.value + 'px';
                    processImages();
                }
                if (e.target.id === 'setting-corner-radius') {
                    document.getElementById('corner-radius-display').textContent = e.target.value + 'px';
                    processImages();
                }
            });

            document.addEventListener('change', function(e) {
                const colorPickers = ['setting-bg-color', 'setting-gradient-start', 'setting-gradient-end', 'setting-pattern-color1', 'setting-pattern-color2'];
                if (colorPickers.includes(e.target.id)) {
                    console.log('Color picker changed (change event):', e.target.id, e.target.value);
                    
                    if (e.target.id === 'setting-bg-color') {
                        canvasWrapper.style.backgroundColor = e.target.value;
                    }
                    
                    processImages();
                }
                
                if (e.target.id === 'setting-gradient-direction') {
                    console.log('Gradient direction changed:', e.target.value);
                    processImages();
                }
                if (e.target.id === 'setting-pattern') {
                    console.log('Pattern changed:', e.target.value);
                    processImages();
                }
            });

            clearBtn.addEventListener('click', clearAll);
            downloadBtn.addEventListener('click', downloadImage);
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (file) {
                loadImage(file);
            }
        }

        function loadImage(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    originalImage = img;
                    
                    const maxWidth = 800;
                    const maxHeight = 600;
                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth) {
                        height = (maxWidth / width) * height;
                        width = maxWidth;
                    }
                    if (height > maxHeight) {
                        width = (maxHeight / height) * width;
                        height = maxHeight;
                    }

                    displayWidth = width;
                    displayHeight = height;

                    resultCanvas.width = width;
                    resultCanvas.height = height;

                    resultCtx.drawImage(img, 0, 0, width, height);
                    
                    canvasWrapper.style.width = width + 'px';
                    canvasWrapper.style.height = height + 'px';

                    uploadPrompt.style.display = 'none';
                    canvasWrapper.classList.add('active');
                    downloadBtn.disabled = false;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        let maskCustomImage = null;
        let alphaMaskImage = null;

        function handleMaskCustomUpload(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    maskCustomImage = img;
                    const fileNameElement = document.getElementById('mask-custom-file-name');
                    if (fileNameElement) {
                        fileNameElement.textContent = file.name;
                    }
                    processImages();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function handleAlphaMaskUpload(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    alphaMaskImage = img;
                    const fileNameElement = document.getElementById('alpha-mask-file-name');
                    if (fileNameElement) {
                        fileNameElement.textContent = file.name;
                    }
                    processImages();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function clearAll() {
            if (originalImage) {
                if (confirm('Clear all images?')) {
                    originalImage = null;
                    displayWidth = 0;
                    displayHeight = 0;
                    uploadPrompt.style.display = 'flex';
                    canvasWrapper.classList.remove('active');
                    downloadBtn.disabled = true;
                    resultCtx.clearRect(0, 0, resultCanvas.width, resultCanvas.height);
                    
                    document.title = 'Инструмент Фона и Маски | CaliperTools';
                    const metaDescription = document.querySelector('meta[name="description"]');
                    if (metaDescription) {
                        metaDescription.setAttribute('content', 'Process image backgrounds and masks with 13 professional tools. Remove backgrounds, add colors, apply masks, and more. No upload required.');
                    }
                    
                    const newUrl = new URL(window.location.href);
                    const segments = newUrl.pathname.split('/');
                    const imageIndex = segments.indexOf('Image');
                    
                    if (imageIndex !== -1) {
                        newUrl.pathname = segments.slice(0, imageIndex + 1).join('/') + '/Image-Background-Mask.html';
                    } else {
                        newUrl.pathname = '/Image/Image-Background-Mask.html';
                    }
                    newUrl.hash = ''; //移除哈希值
                    window.history.pushState({}, '', newUrl);
                    
                    toolButtons.forEach(function(b) {
                        b.classList.remove('active');
                    });
                    currentMode = null;
                }
            }
        }

        function downloadImage() {
            if (!originalImage) return;

            const link = document.createElement('a');
            link.download = 'processed-image.png';
            link.href = resultCanvas.toDataURL('image/png');
            link.click();
        }

        init();
    </script>


</body>
</html>